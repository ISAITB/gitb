<div class="page users create">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="title">{{ (controller.update?'Update':'Create') + ' trigger' }}</h4>
        </div>
        <form class="form-horizontal">
            <div class="panel-body">
                <!-- Error messages -->
                <div class="row">
                    <div class="col-xs-10 col-xs-offset-1">
                        <div uib-alert ng-repeat="alert in controller.alerts" ng-class="'alert-' + alert.type" close="controller.closeAlert($index)">{{alert.msg}}</div>
                    </div>
                </div>
                <!-- Trigger form -->
                <div class="row">
                    <div class="col-xs-10 col-xs-offset-1">
                        <div class="form-group">
                            <label class="col-xs-3 control-label" for="name">* Name:</label>
                            <div class="col-xs-8"><input id="name" ng-model="controller.trigger.name" class="form-control" type="text"></div>
                            <div tb-tooltip="The name of the trigger that will identify it and be displayed in selection lists."></div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-3 control-label" for="description">Description:</label>
                            <div class="col-xs-8"><textarea id="description" ng-model="controller.trigger.description" class="form-control"></textarea></div>
                            <div tb-tooltip="A description to help distinguish this trigger and summarise its purpose."></div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-3 control-label" for="event">* Event type:</label>
                            <div class="col-xs-8"><select id="event" ng-change="controller.eventTypeChanged()" ng-model="controller.trigger.event" ng-options="eventType.label for eventType in controller.eventTypes track by eventType.id" class="form-control"></select></div>
                            <div tb-tooltip="The event that will cause this trigger to fire."></div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-3 control-label" for="active">Active:</label>
                            <div class="col-xs-8">
                                <input id="active" ng-model="controller.trigger.active" type="checkbox" class="form-check">
                                <div tb-inline="true" tb-tooltip="Check this to activate this trigger and have it fire when the defined event occurs. An inactive trigger is effectively disabled."></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <div class="form-separator">
                            <h4 class="title">Web service details <span uib-tooltip="When the trigger's event occurs a call will be made to the web service configured below. This service is expected to implement the GITB processing service API. For information on how to implement this service check the Test Bed's user guide (link in the screen's footer)."><i class="fa fa-question-circle"></i></span></h4>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-10 col-xs-offset-1">
                        <div class="form-group">
                            <label class="col-xs-3 control-label" for="url">* Endpoint URL:</label>
                            <div class="col-xs-7">
                                <input id="url" ng-model="controller.trigger.url" class="form-control" type="text">
                            </div>
                            <div class="col-xs-1">
                                <button class="btn btn-default" type="button" ng-click="controller.testEndpoint()" ng-disabled="!controller.trigger.url"><span class="tab" ng-if="controller.testPending"><i class="fa fa-spinner fa-spin fa-lg fa-fw"></i></span><span ng-if="!controller.testPending">Test</span></button>
                            </div>
                            <div tb-tooltip="The URL of the web service that will be called when the trigger fires. This URL must be provided as the full address needed to resolve the service's WSDL. Note that the URL provided is the one the Test Bed will use internally for the call (i.e. it doesn't have to be publicly available)."></div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-3 control-label" for="operation">Operation:</label>
                            <div class="col-xs-7"><input id="operation" ng-model="controller.trigger.operation" class="form-control" type="text"></div>
                            <div class="col-xs-offset-1 col-xs-1 no-left-padding">
                                <div tb-tooltip="An optional operation identifier to pass to the service. As a GITB processing service may define multiple operations this identifier can be used to determine the one intended by this trigger."></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-3 control-label">Input data:</label>
                            <div class="col-xs-8 trigger-data-checks">
                                <label class="checkbox-inline" ng-if="controller.triggerData.community.visible">
                                    <input type="checkbox" ng-model="controller.triggerData.community.selected">{{controller.dataTypeMap[controller.triggerData.community.dataType]}}
                                </label>
                                <label class="checkbox-inline" ng-if="controller.triggerData.organisation.visible">
                                    <input type="checkbox" ng-model="controller.triggerData.organisation.selected">{{controller.dataTypeMap[controller.triggerData.organisation.dataType]}}
                                </label>
                                <label class="checkbox-inline" ng-if="controller.triggerData.system.visible">
                                    <input type="checkbox" ng-model="controller.triggerData.system.selected">{{controller.dataTypeMap[controller.triggerData.system.dataType]}}
                                </label>
                                <label class="checkbox-inline" ng-if="controller.triggerData.specification.visible">
                                    <input type="checkbox" ng-model="controller.triggerData.specification.selected">{{controller.dataTypeMap[controller.triggerData.specification.dataType]}}
                                </label>
                                <label class="checkbox-inline" ng-if="controller.triggerData.actor.visible">
                                    <input type="checkbox" ng-model="controller.triggerData.actor.selected">{{controller.dataTypeMap[controller.triggerData.actor.dataType]}}
                                </label>
                            </div>
                            <div class="col-xs-1 no-left-padding">
                                <div tb-tooltip="Optional data that will be provided as input to the service when it is called. The type of data available depends on the trigger's event type."></div>
                            </div>
                            <div ng-if="controller.triggerData.organisationParameter.visible">
                                <div class="col-xs-offset-3 col-xs-8 trigger-data-checks" ng-if="controller.triggerData.organisationParameter.visible">
                                    <label class="checkbox-inline">
                                        <input type="checkbox" ng-model="controller.triggerData.organisationParameter.selected">{{controller.dataTypeMap[controller.triggerData.organisationParameter.dataType]}}
                                    </label>
                                </div>
                                <div class="col-xs-offset-3 col-xs-8" uib-collapse="!controller.triggerData.organisationParameter.selected">
                                    <div class="trigger-data-properties-container">
                                        <table class="table">
                                            <thead>
                                                <th></th>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Identifier</th>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="parameter in controller.organisationParameters" ng-click="parameter.selected = !parameter.selected">
                                                   <td><input type="checkbox" ng-model="parameter.selected"></td>
                                                   <td>{{parameter.name}}</td> 
                                                   <td>{{controller.parameterType(parameter)}}</td>
                                                   <td>{{parameter.testKey}}</td> 
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div ng-if="controller.triggerData.systemParameter.visible">
                                <div class="col-xs-offset-3 col-xs-8 trigger-data-checks">
                                    <label class="checkbox-inline">
                                        <input type="checkbox" ng-model="controller.triggerData.systemParameter.selected">{{controller.dataTypeMap[controller.triggerData.systemParameter.dataType]}}
                                    </label>
                                </div>
                                <div class="col-xs-offset-3 col-xs-8" uib-collapse="!controller.triggerData.systemParameter.selected">
                                    <div class="trigger-data-properties-container">
                                        <table class="table">
                                            <thead>
                                                <th></th>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Identifier</th>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="parameter in controller.systemParameters" ng-click="parameter.selected = !parameter.selected">
                                                   <td><input type="checkbox" ng-model="parameter.selected"></td>
                                                   <td>{{parameter.name}}</td> 
                                                   <td>{{controller.parameterType(parameter)}}</td>
                                                   <td>{{parameter.testKey}}</td> 
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <div class="form-separator">
                            <h4 class="title">Trigger status <span uib-tooltip="The presented result is the trigger's latest outcome from calling the configured web service. In case of failure you can also view the incremental error messages that were reported when the service call was attempted."><i class="fa fa-question-circle"></i></span></h4>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-10 col-xs-offset-1">
                        <div class="form-group">
                            <label class="col-xs-3 control-label" for="url">Latest result:</label>
                            <div class="col-xs-1">
                                <p class="form-control-static status-display" ng-class="{'bg-info': controller.trigger.status == controller.statusTextUnknown.id,'bg-success': controller.trigger.status == controller.statusTextOk.id,'bg-danger': controller.trigger.status == controller.statusTextError.id}">
                                    {{controller.trigger.statusText}}
                                </p>
                            </div>
                            <div class="col-xs-7">
                                <div class="btn-toolbar">
                                    <button class="btn btn-default" type="button" ng-click="controller.viewLatestErrors()" ng-if="controller.trigger.status == controller.statusTextError.id">View errors</button>
                                    <button class="btn btn-default" type="button" ng-click="controller.clearStatus()" ng-if="controller.trigger.status == controller.statusTextOk.id || controller.trigger.status == controller.statusTextError.id" ng-disabled="controller.clearStatusDisabled()"><span class="tab" ng-if="controller.clearStatusPending"><i class="fa fa-spinner fa-spin fa-lg fa-fw"></i></span><span ng-if="!controller.clearStatusPending">Clear</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-footer">
                <div class="row">
                    <div class="col-xs-3"></div>
                    <div class="col-xs-8 btn-toolbar">
                        <button class="btn btn-default" type="submit" ng-click="controller.save()" ng-disabled="controller.saveDisabled()"><span class="tab" ng-if="controller.savePending"><i class="fa fa-spinner fa-spin fa-lg fa-fw"></i></span>Save</button>
                        <button class="btn btn-default" type="button" ng-click="controller.preview()" ng-disabled="controller.previewDisabled()"><span class="tab" ng-if="controller.previewPending"><i class="fa fa-spinner fa-spin fa-lg fa-fw"></i></span>Preview service call</button>
                        <button ng-if="controller.update" class="btn btn-default" type="button" ng-disabled="controller.deleteDisabled()" ng-click="controller.delete()"><span class="tab" ng-if="controller.deletePending"><i class="fa fa-spinner fa-spin fa-lg fa-fw"></i></span>Delete</button>
                        <button class="btn btn-default" type="button" ng-click="controller.back()"> {{ controller.update?'Back':'Cancel' }}</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
